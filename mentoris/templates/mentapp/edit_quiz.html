<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Quiz</title>

    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

    {% load static %}
    <link rel="stylesheet" href="{% static '/css/colors.css'%}">
    <link rel="stylesheet" href="{% static '/css/quiz_styles.css'%}">

    <script src="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.js"></script>
    <script>
        customElements.define("latex-js", latexjs.LaTeXJSComponent);
    </script>

    <style>
        .delete {
            font-weight: bold;
            background: var(--KontinuaRed);
        }

        .question_support_label {
            text-align: center;
            border: 2px solid Black;
            border-radius: 25px;
            margin: 5px;
            width: 8em;
            height: 2em;
            vertical-align: middle;
        }

        #quiz_content {
            width: 35em;
        }

        #quiz_content {
            padding: 10px;
            float: left;
            margin-bottom: 0px;
        }
    </style>

</head>

<body>
    <!--Include AJAX-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!--Include Header-->
    <iframe src="header.html" width="100%" height="95px" frameBorder="0"
        style="display: block; padding: 0px; margin: 0px;"></iframe>

    <div id="quiz_content" class="bordered" background="red">
        <ul id="quiz_questions_list" style="list-style-type:none;">
            {% for question_Loc_and_quiz in questions_Loc_and_quiz %}
            <li id="{{question_Loc_and_quiz.0.question.question_id}}">
                <div class="bordered">
                    <div>
                        <div style="float: left;">
                            <p class="small_margin">
                                <span class="bold_font">Ordering: </span>
                                <span class="question_ordering">{{question_Loc_and_quiz.1.ordering}}</span>
                            </p>
                            <p class="small_margin">
                                <span class="bold_font">Difficulty: </span>
                                {{question_Loc_and_quiz.0.question.conceptual_difficulty}}
                            </p>
                            <p class="small_margin">
                                <span class="bold_font">Volume: </span>
                                {{question_Loc_and_quiz.0.question.chapter.volume.volume_id}}
                            </p>
                            <p class="small_margin">
                                <span class="bold_font">Chapter: </span>
                                {{question_Loc_and_quiz.0.question.chapter.chapter_id}}
                            </p>
                            <p class="small_margin">
                                <span class="bold_font">Creator: </span>
                                {{question_Loc_and_quiz.0.question.creator.full_name}}
                            </p>
                            <p class="small_margin">
                                <span class="bold_font">Point Value: </span>
                                {{question_Loc_and_quiz.0.question.point_value}}
                            </p>
                            <p class="small_margin">
                                <span class="bold_font">Time (minutes): </span>
                                {{question_Loc_and_quiz.0.question.time_required_mins}}
                            </p>
                        </div>
                        <div style="float: right;">
                            <ul style="list-style-type:none;">
                                <li>
                                    <button class="delete question_button">Delete</button>
                                </li>
                                <li>
                                    <button class="decrease_order question_button">
                                        <img src="{% static 'up_arrow.svg' %}" width="50" />
                                    </button>
                                </li>

                                <li>
                                    <button class="increase_order question_button">
                                        <img src="{% static 'down_arrow.svg' %}" width="50" />
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div style="clear: both;">
                            <latex-js>{{question_Loc_and_quiz.0.question_latex}}</latex-js>
                        </div>
                        <div style="float: right;">
                            <p class="bold_font question_support_label" style="background-color:  var(--KontinuaBlue);">
                                Question</p>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div id="right_panel">
        <div class="bordered" id="meta_data">
            <form action="" method="post">
                {% csrf_token %}
                <table>
                    {{form.as_table}}
                </table>
                <input type="submit" value="Submit" />
            </form>

        </div>
        <button class="question_button" id="add_question"
            onclick="location.href='/edit_quiz_add_question/{{quiz_instance.quiz_id}}'" type="button">Add Question
        </button>
        <button class="question_button" id="add_support"
            onclick="location.href='/edit_quiz_add_support/{{quiz_instance.quiz_id}}'">Add Support</button>
        <button class="question_button" id="save_button">Save</button>
        <div id="save_status" class="bordered" style="width:30em;"></div>
    </div>
    </div>

    <iframe src="footer.html" width="100%" frameBorder="0"></iframe>


    <script type="text/javascript">

        $(document).ready(function () {
            const form = document.getElementById("form");

            // TODO use ajax for submit
            /* override submit button action
            $("#form").submit( function(){
                request =  $.ajax({
                    type: "POST",
                    url: "/make_quiz/{{quiz_instance.quiz_id}}",
                    dataType: 'json',
                    data:{
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        form: $(this).val()
                    }, 

                    success:function(response){
                        console.log("response");
                    if(response.success) {
                        console.log("success");
                    } else {
                        console.log("failure");
                    }
                    }   
                });
            });
            */

            // TODO modify when add question page is added
            // function to save
            $('#save_button').on('click', function (event) {
                var list = document.getElementById("quiz_questions_list").children;
                var orderings = []
                var ids = []

                for (var i = 0; i < list.length; ++i) {
                    ids.push(list[i].id);
                    orderings.push(i);
                }

                var request = $.ajax({
                    type: "POST",
                    url: "/edit_quiz/{{quiz_instance.quiz_id}}",
                    dataType: 'json',
                    data: {
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        command: "save",
                        orderings: JSON.stringify(orderings),
                        ids: JSON.stringify(ids)
                    }
                });

                request.done(function () {
                    const save_status = document.getElementById("save_status");
                    const save_date = new Date();
                    save_status.innerHTML = "Success! Quiz Saved at " + save_date.toString();
                });

                request.fail(function () {
                    const save_status = document.getElementById("save_status");
                    const save_date = new Date();
                    save_status.innerHTML = "Oh no! There was an error saving at: " + save_date.toString();
                });

            });

            // Function to handle deletions
            $('.delete').on('click', function (event) {
                var list_element = document.getElementById("quiz_questions_list");
                var list = document.getElementById("quiz_questions_list").children;
                var index = -1;

                for (var i = 0; i < list.length; ++i) {
                    if (list[i].contains($(this)[0])) {
                        index = i;
                    }
                }

                for (var i = 0; i < list.length; ++i) {
                    if (i > index) {
                        list[i].getElementsByClassName("question_ordering")[0].innerHTML = (i - 1).toString();
                    }
                    if (list[i].contains($(this)[0])) {
                        index = i;
                    }
                }
                list_element.removeChild(list[index]);
            });

            // Function to handle increasing order
            $('.increase_order').on('click', function (event) {
                var list = document.getElementById("quiz_questions_list").children;

                var index = -1;
                for (var i = 0; i < list.length; ++i) {
                    if (list[i].contains($(this)[0])) {
                        index = i;
                    }
                }

                if (index != list.length - 1) {
                    list[index].getElementsByClassName("question_ordering")[0].innerHTML = (index + 1).toString();
                    list[index + 1].getElementsByClassName("question_ordering")[0].innerHTML = (index).toString();
                    list[index].parentNode.insertBefore(list[index + 1], list[index]);
                    list[index + 1].scrollIntoView();

                }
            });


            // Function to handle decreasing order
            $('.decrease_order').on('click', function (event) {
                var list = document.getElementById("quiz_questions_list").children;

                var index = -1;
                for (var i = 0; i < list.length; ++i) {
                    if (list[i].contains($(this)[0])) {
                        index = i;
                    }
                }

                if (index != 0) {
                    list[index].getElementsByClassName("question_ordering")[0].innerHTML = (index - 1).toString();
                    list[index - 1].getElementsByClassName("question_ordering")[0].innerHTML = (index).toString();
                    list[index - 1].parentNode.insertBefore(list[index], list[index - 1]);
                    list[index - 1].scrollIntoView();
                }
            });
        });
    </script>

</body>

</html>